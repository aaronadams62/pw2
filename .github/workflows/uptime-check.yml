name: Uptime Check

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  uptime:
    name: Check Site Availability
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ vars.UPTIME_CHECK_BASE_URL }}
    steps:
      - name: Validate configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${BASE_URL:-}" ]; then
            echo "::warning::UPTIME_CHECK_BASE_URL is not configured. Skipping uptime checks."
            echo "RUN_CHECKS=false" >> "$GITHUB_ENV"
          else
            echo "Monitoring base URL: $BASE_URL"
            echo "RUN_CHECKS=true" >> "$GITHUB_ENV"
          fi

      - name: Check homepage
        if: env.RUN_CHECKS == 'true'
        shell: bash
        run: |
          set -euo pipefail
          code=$(curl -sS -o /dev/null -w "%{http_code}" "$BASE_URL/")
          echo "Homepage status: $code"
          if [ "$code" -lt 200 ] || [ "$code" -ge 400 ]; then
            echo "Homepage check failed for $BASE_URL/"
            exit 1
          fi

      - name: Check admin route
        if: env.RUN_CHECKS == 'true'
        shell: bash
        run: |
          set -euo pipefail
          code=$(curl -sS -o /dev/null -w "%{http_code}" "$BASE_URL/admin")
          echo "Admin route status: $code"
          if [ "$code" -lt 200 ] || [ "$code" -ge 400 ]; then
            echo "Admin route check failed for $BASE_URL/admin"
            exit 1
          fi
